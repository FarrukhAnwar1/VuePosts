import{d as D,u as T,j as I,g as l,s as f,f as p,y as L,_ as $,o as d,c as u,a as c,w as z,v as k,h,n as E,t as m,b as v,F as x,r as R,i as S,p as V,e as A}from"./index-ee57cedc.js";import{p as B}from"./purify.es-0c4a0514.js";const K=D({data(){return{mainStore:T(),content:"",maxContentLength:2e3,sendingData:!1,userProfilesSnapshot:null,userProfilesUnsubscribe:null}},mounted(){this.userProfilesUnsubscribe=I(l(this.mainStore.firestore,"userProfiles"),e=>{this.userProfilesSnapshot=e})},unmounted(){this.userProfilesUnsubscribe&&this.userProfilesUnsubscribe()},methods:{async handlePostButtonClick(){var U;this.sendingData=!0;const e=/#(\w+)/g,t=this.content.match(e),s=t?t.map(a=>a.slice(1)):[],i=/@([\w().]+)/g,n=this.content.match(i),r=n?n.map(a=>a.slice(1)):[],o={authorUid:(U=this.mainStore.user)==null?void 0:U.uid,authorUsername:this.mainStore.username,content:B.sanitize(this.trimmedContent).toString(),createdAt:f()},P=await p(l(this.mainStore.firestore,"posts"),o);s.length>0&&s.forEach(async a=>{const g={postDocumentId:P.id,tag:a,createdAt:f()};await p(l(this.mainStore.firestore,"tags"),g)});let b="";const y=await L(l(this.mainStore.firestore,"userProfiles"));r.length>0&&r.forEach(async a=>{var C;for(const w of y.docs)w.data().username===a&&(b=w.id);const g={postDocumentId:P.id,mentionedUid:b,mentionerUid:(C=this.mainStore.user)==null?void 0:C.uid,createdAt:f()};await p(l(this.mainStore.firestore,"mentions"),g)}),this.content="",this.sendingData=!1},handleTabPress(e){const t=this.$refs.postContentInput,s=t.selectionStart||0,i=t.selectionEnd||0;if(s!==void 0&&i!==void 0)if(this.suggestedMentionUsernames.size>0){const n=this.$refs.suggestedUsernameSelect,r=n.value.length;this.content=this.content.substring(0,s-this.extractMention.length)+n.value+this.content.substring(i),this.$nextTick(()=>{t.selectionStart=t.selectionEnd=s+r})}else{const n="    ";this.content=this.content.substring(0,s)+n+this.content.substring(i),this.$nextTick(()=>{t.selectionStart=t.selectionEnd=s+n.length})}},handleVerticalKeyPress(e,t){if(this.suggestedMentionUsernames.size>0){e.preventDefault();const s=this.$refs.suggestedUsernameSelect,i=s.value,n=Array.from(this.suggestedMentionUsernames),r=n.findIndex(o=>o===i);t==="up"?s.value=n[Math.max(r-1,0)]:t==="down"&&(s.value=n[Math.min(r+1,n.length-1)])}}},computed:{trimmedContent(){return this.content.trim()},isPostTooLong(){return this.trimmedContent.length>this.maxContentLength},isPostTooShort(){return this.trimmedContent.length===0},existingUsernames(){var t;const e=new Set;return(t=this.userProfilesSnapshot)==null||t.forEach(s=>{const i=s.data();e.add(i.username)}),e},suggestedMentionUsernames(){const e=new Set,t=this.extractMention;if(t.length>0){for(const s of this.existingUsernames)s.toLowerCase().startsWith(t.toLowerCase())&&e.add(s);for(const s of this.existingUsernames)s.toLowerCase().includes(t.toLowerCase())&&e.add(s)}return e},extractMention(){const e=/@([\w().]+)/g;let t=0;const s=this.$refs.postContentInput;s&&(t=s.selectionStart||0);let i=null;for(;(i=e.exec(this.content))!==null;){const n=i.index,r=e.lastIndex;if(n<=t&&t<=r)return i[1]}return""},calculatedSelectOptionsSize(){return Math.max(2,Math.min(this.suggestedMentionUsernames.size,6))}}});const M=e=>(V("data-v-625c9698"),e=e(),A(),e),_={class:"text-center mb-2"},O=M(()=>c("h1",null,"Create Post",-1)),F={key:0,class:"redText"},N=M(()=>c("h3",{class:"text-white-50"},"Suggested Usernames",-1)),j=["size"],W=["value"],q=["disabled"];function G(e,t,s,i,n,r){return d(),u("div",_,[O,c("form",{onSubmit:t[5]||(t[5]=S(o=>e.handlePostButtonClick(),["prevent"])),class:"d-flex flex-column mx-5"},[z(c("textarea",{type:"text",class:"mb-2",rows:"8",placeholder:"Enter content (CTRL + Enter for Submit Shortcut)",ref:"postContentInput","onUpdate:modelValue":t[0]||(t[0]=o=>e.content=o),onKeydown:[t[1]||(t[1]=h(o=>e.handleVerticalKeyPress(o,"up"),["up"])),t[2]||(t[2]=h(o=>e.handleVerticalKeyPress(o,"down"),["down"])),t[3]||(t[3]=h(S((...o)=>e.handleTabPress&&e.handleTabPress(...o),["prevent"]),["tab"]))],onKeyup:t[4]||(t[4]=h(S(o=>e.handlePostButtonClick(),["ctrl"]),["enter"]))},`\r
            `,544),[[k,e.content]]),c("h3",{class:E({redText:e.isPostTooLong})},"Characters: "+m(e.trimmedContent.length)+" / "+m(e.maxContentLength),3),e.isPostTooLong?(d(),u("h3",F,"Post content must be less than "+m(e.maxContentLength)+" characters",1)):v("",!0),e.suggestedMentionUsernames.size>0?(d(),u(x,{key:1},[N,c("select",{size:e.calculatedSelectOptionsSize,class:"text-center bg-black",ref:"suggestedUsernameSelect"},[(d(!0),u(x,null,R(e.suggestedMentionUsernames,o=>(d(),u("option",{value:o,class:"usernameOption"},m(o),9,W))),256))],8,j)],64)):v("",!0),c("button",{type:"submit",class:"btn btn-primary mt-2 large-button-text",disabled:e.isPostTooLong||e.isPostTooShort||e.sendingData},"Post",8,q)],32)])}const X=$(K,[["render",G],["__scopeId","data-v-625c9698"]]);export{X as default};
